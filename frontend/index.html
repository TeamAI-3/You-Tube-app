<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MiniTube</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { font-family: system-ui, Arial; margin: 0; padding: 12px; }
    .row { display: flex; gap: 8px; }
    input { flex: 1; padding: 10px; font-size: 16px; }
    button { padding: 10px 12px; font-size: 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
    .card { display: flex; gap: 10px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; cursor: pointer; }
    .thumb { width: 140px; height: 78px; object-fit: cover; border-radius: 8px; }
    .title { font-weight: 700; }
    .muted { opacity: 0.7; font-size: 13px; margin-top: 6px; }
    .playerWrap { margin-top: 12px; }
    iframe { width: 100%; height: 220px; border: 0; border-radius: 12px; }
  </style>
</head>
<body>
  <div class="row">
    <input id="q" placeholder="Поиск по YouTube..." />
    <button id="btn">Искать</button>
  </div>

  <div class="playerWrap" id="playerWrap" style="display:none;">
    <iframe id="player" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  </div>

  <div class="grid" id="list"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.expand(); tg.ready(); }

    const API_BASE = "https://you-tube-app.onrender.com";

    const qEl = document.getElementById("q");
    const btn = document.getElementById("btn");
    const list = document.getElementById("list");
    const playerWrap = document.getElementById("playerWrap");
    const player = document.getElementById("player");

    function esc(s) {
      return (s || "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function render(items) {
      list.innerHTML = "";
      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <img class="thumb" src="${it.thumbnail}" />
          <div>
            <div class="title">${esc(it.title)}</div>
            <div class="muted">${esc(it.channelTitle)}</div>
          </div>
        `;
        div.onclick = () => openVideo(it.videoId);
        list.appendChild(div);
      });
    }

    function openVideo(videoId) {
      playerWrap.style.display = "block";
      player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&playsinline=1`;

      if (tg?.BackButton) {
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
          player.src = "";
          playerWrap.style.display = "none";
          tg.BackButton.hide();
        });
      }
    }

    async function doSearch() {
      const q = qEl.value.trim();
      if (!q) return;

      btn.disabled = true;
      btn.textContent = "…";
      try {
        const r = await fetch(`${API_BASE}/search?q=${encodeURIComponent(q)}&max_results=12`);
        const data = await r.json();
        render(data.items || []);
      } catch (e) {
        alert("Ошибка. Проверь API_BASE или бэкенд.");
      } finally {
        btn.disabled = false;
        btn.textContent = "Искать";
      }
    }

    btn.onclick = doSearch;
    qEl.addEventListener("keydown", (e) => { if (e.key === "Enter") doSearch(); });
  </script>
</body>
</html>
